apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: agent-partial-tool
  labels:
    multi-provider: "true"
spec:
  description: Test agent with a tool using partial parameters
  steps:
    - name: setup-mock-service
      try:
        - apply:
            file: ../shared/mock-geocoding-api.yaml
        - assert:
            resource:
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: mock-geocoding-api
              status:
                readyReplicas: 1
        - assert:
            resource:
              apiVersion: v1
              kind: Endpoints
              metadata:
                name: mock-geocoding-api
        - script:
            content: |
              MOCK_URL="http://mock-geocoding-api.$NAMESPACE.svc.cluster.local"
              kubectl run test-mock-ready --image=curlimages/curl --rm -i --restart=Never -n $NAMESPACE -- \
                curl -f -s "${MOCK_URL}/v1/search?name=New+York&count=1"
            env:
              - name: NAMESPACE
                value: ($namespace)
            timeout: 30s
        - script:
            content: |
              helm install mock-llm oci://ghcr.io/dwmkerr/charts/mock-llm \
                --version 0.1.28 \
                --namespace $NAMESPACE \
                --values mock-llm-values.yaml
            env:
              - name: NAMESPACE
                value: ($namespace)
        - script:
            content: |
              helm install ark-tenant ../../charts/ark-tenant --namespace $NAMESPACE --create-namespace --wait
            env:
              - name: NAMESPACE
                value: ($namespace)
        - assert:
            resource:
              apiVersion: v1
              kind: Pod
              metadata:
                labels:
                  app.kubernetes.io/name: mock-llm
              status:
                phase: Running
                (contains(conditions[?type == 'Ready'].status, 'True')): true
        - assert:
            resource:
              apiVersion: ark.mckinsey.com/v1alpha1
              kind: Model
              metadata:
                name: test-model
              status:
                conditions:
                  - type: ModelAvailable
                    status: "True"
      catch:
        - events: {}
        - describe:
            apiVersion: v1
            kind: Pod
            selector: app.kubernetes.io/name=mock-llm
        - describe:
            apiVersion: ark.mckinsey.com/v1alpha1
            kind: Model
            name: test-model

    - name: create-tool-and-agent
      try:
        - apply:
            file: manifests/a0[3-4]-*.yaml
        - assert:
            resource:
              apiVersion: ark.mckinsey.com/v1alpha1
              kind: Agent
              metadata:
                name: partial-tool-agent
              status:
                (conditions[?type == 'Available']):
                  - status: "True"
      catch:
        - events: {}
        - describe:
            apiVersion: ark.mckinsey.com/v1alpha1
            kind: Agent
            name: partial-tool-agent

    - name: create-and-verify-query
      try:
        - apply:
            file: manifests/a05-query.yaml
        - assert:
            resource:
              apiVersion: ark.mckinsey.com/v1alpha1
              kind: Query
              metadata:
                name: partial-tool-query
              status:
                (conditions[?type == 'Completed']):
                  - status: "True"
        - assert:
            resource:
              apiVersion: ark.mckinsey.com/v1alpha1
              kind: Query
              metadata:
                name: partial-tool-query
              status:
                (response != null): true
                (response.target.name): 'partial-tool-agent'
      catch:
        - events: {}
        - describe:
            apiVersion: ark.mckinsey.com/v1alpha1
            kind: Query
            name: partial-tool-query
