# Prometheus TLS Configuration Test

This test validates that the Prometheus ServiceMonitor uses secure TLS configuration with cert-manager managed certificates.

## What it tests

- Cert-manager Issuer and Certificate resources are created successfully
- Metrics certificate secret (`metrics-server-cert`) is generated by cert-manager
- ServiceMonitor uses secure TLS configuration:
  - `insecureSkipVerify: false` (certificate verification enabled)
  - CA certificate reference from `metrics-server-cert` secret
  - TLS certificate reference from `metrics-server-cert` secret
  - Private key reference from `metrics-server-cert` secret
- All certificate references point to the correct secret and keys
- Certificate DNS names match the ServiceMonitor serverName (`ark.ark-system.svc`)

## Prerequisites

- Kubernetes cluster with cert-manager installed (or test will install it)
- Prometheus Operator CRDs installed (for ServiceMonitor resource)

## Running

```bash
chainsaw test tests/prometheus-tls-config
```

## Test Structure

1. **verify-cert-manager-installed**: Ensures cert-manager is available
2. **setup-cert-manager-resources**: Creates Issuer and Certificate resources in `ark-system` namespace
3. **verify-metrics-cert-secret-exists**: Validates the secret is created by cert-manager
4. **apply-service-monitor**: Applies the ServiceMonitor with secure TLS config
5. **verify-secure-tls-config**: Validates the TLS configuration is secure

## Expected Results

- All certificate resources are created and ready in `ark-system` namespace
- ServiceMonitor has `insecureSkipVerify: false`
- All certificate references are correctly configured
- Certificate DNS names match the serverName in ServiceMonitor
- No security vulnerabilities in TLS configuration

## Configuration

The test uses the `ark-system` namespace to match the production Kustomize configuration. The certificate is issued for:
- `ark.ark-system.svc`
- `ark.ark-system.svc.cluster.local`

