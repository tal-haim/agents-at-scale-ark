apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: query-token-usage
spec:
  description: Test query token usage tracking and validation
  steps:
  - name: setup-resources
    try:
    # Install mock-llm with token usage support
    - script:
        content: |
          helm install mock-llm oci://ghcr.io/dwmkerr/charts/mock-llm \
            --version 0.1.16 \
            --namespace $NAMESPACE \
            --values mock-llm-values.yaml
        env:
        - name: NAMESPACE
          value: ($namespace)
    # Install ark-tenant for RBAC
    - script:
        content: |
          helm install ark-tenant ../../charts/ark-tenant --namespace $NAMESPACE --create-namespace --wait
        env:
        - name: NAMESPACE
          value: ($namespace)
    # Wait for Model to be available before creating agents/queries
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Model
          metadata:
            name: test-model
          status:
            conditions:
            - type: ModelAvailable
              status: "True"
    # Apply agent and query
    - apply:
        file: manifests/*.yaml
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Agent
          metadata:
            name: token-test-agent

  # Wait fort the query to complete (error or success).
  - name: wait-for-query-completion
    try:
    - wait:
        apiVersion: ark.mckinsey.com/v1alpha1
        kind: Query
        name: token-usage-query
        for:
          condition:
            name: Completed
            value: 'True'
  - name: validate-response
    try:
    - assert:
        # Fast check - the resource won't change since the query is complete.
        timeout: 1s
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Query
          metadata:
            name: token-usage-query
          status:
            # Done - not error. Tokens match the mocked value.
            phase: done
            (length(responses)): 1
            (contains(responses[*].target.name, 'token-test-agent')): true
            (responses[0].content): "Please explain the concept of distributed computing in detail, including key principles, \nadvantages, challenges, and real-world applications. Provide examples of distributed \nsystems and discuss how they handle consistency, availability, and partition tolerance.\n"
            (tokenUsage.promptTokens): 50
            (tokenUsage.completionTokens): 100
            (tokenUsage.totalTokens): 150
    catch:
      # In the case of any errors, show the full query for troubleshooting.
      - describe:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Query
          name: token-usage-query
      - events: {}
